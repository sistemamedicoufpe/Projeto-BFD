<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√µes - NeuroDiagn√≥stico</title>
    <link rel="stylesheet" href="../styles/global.css">
    <link rel="stylesheet" href="../styles/avaliacoes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Menu Toggle Button -->
    <button class="menu-toggle" id="menuToggle" aria-label="Alternar menu">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar mobile-hidden" id="sidebar">
            <div class="logo">
                <h1>üß† NeuroDiagn√≥stico</h1>
            </div>
            <ul class="nav-links">
                <li><a href="../../index.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="pacientes.html"><i class="fas fa-user-injured"></i> Pacientes</a></li>
                <li><a href="avaliacoes.html"><i class="fas fa-brain"></i> Avalia√ß√µes</a></li>
                <li><a href="relatorios.html"><i class="fas fa-chart-bar"></i> Relat√≥rios</a></li>
                <li><a href="configuracoes.html"><i class="fas fa-cog"></i> Configura√ß√µes</a></li>
                <li><a href="ajuda.html"><i class="fas fa-question-circle"></i> Ajuda</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2>Avalia√ß√µes Neurol√≥gicas</h2>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <span id="userName">Usu√°rio</span>
                    <button class="btn-icon" onclick="logout()" title="Sair" style="margin-left: 10px;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Dashboard de Status -->
            <div class="evaluations-dashboard">
                <div class="dashboard-card">
                    <div class="dashboard-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="dashboard-info">
                        <h3 id="totalEvaluations">0</h3>
                        <p>Total de Avalia√ß√µes</p>
                        <div class="dashboard-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="totalProgress" style="width: 100%; background: #667eea;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="dashboard-info">
                        <h3 id="pendingEvaluations">0</h3>
                        <p>Pendentes</p>
                        <div class="dashboard-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="pendingProgress" style="width: 0%; background: #f5576c;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="dashboard-info">
                        <h3 id="completedEvaluations">0</h3>
                        <p>Conclu√≠das</p>
                        <div class="dashboard-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="completedProgress" style="width: 0%; background: #00f2fe;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="dashboard-info">
                        <h3 id="aiEvaluations">0</h3>
                        <p>Com IA</p>
                        <div class="dashboard-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="aiProgress" style="width: 0%; background: #38f9d7;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="search-section">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar por paciente ou tipo de avalia√ß√£o..." class="search-input">
                </div>
                <div class="exam-filters">
                    <button class="filter-btn active" data-type="all">Todos</button>
                    <button class="filter-btn" data-type="cognitive"><i class="fas fa-brain"></i> Cognitiva</button>
                    <button class="filter-btn" data-type="neurological"><i class="fas fa-wave-square"></i> Neurol√≥gica</button>
                    <button class="filter-btn" data-type="imaging"><i class="fas fa-x-ray"></i> Imagem</button>
                </div>
            </div>

            <!-- Evaluations Grid -->
            <div class="evaluations-grid" id="evaluationsGrid">
                <!-- Cards ser√£o inseridos dinamicamente -->
            </div>

            <!-- Pagination -->
            <div class="pagination" style="margin-top: 30px;">
                <button class="btn btn-outline btn-sm" id="prevPage">
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="pagination-info" id="pageInfo">P√°gina 1 de 1</span>
                <button class="btn btn-outline btn-sm" id="nextPage">
                    Pr√≥xima <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Evaluation Detail Modal -->
    <div id="evaluationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalhes da Avalia√ß√£o</h3>
                <button class="close-btn" onclick="closeEvaluationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="evaluationModalContent">
                <!-- Conte√∫do ser√° inserido dinamicamente -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeEvaluationModal()">Fechar</button>
                <button class="btn btn-primary" onclick="editEvaluation()">
                    <i class="fas fa-edit"></i> Editar
                </button>
            </div>
        </div>
    </div>

    <script src="../scripts/common.js"></script>
    <script src="../scripts/storage.js"></script>
    <script>
        let currentPage = 1;
        const itemsPerPage = 9;
        let allEvaluations = [];
        let filteredEvaluations = [];
        let currentFilter = 'all';

        // Carregar informa√ß√µes do usu√°rio
        function loadUserInfo() {
            const userData = JSON.parse(localStorage.getItem('neurodiag_user_data') || '{}');
            const userName = document.getElementById('userName');

            if (userData.nome) {
                userName.textContent = userData.nome.split(' ')[0];
            }
        }

        // Carregar avalia√ß√µes
        function loadEvaluations() {
            allEvaluations = EvaluationsManager.getAll();
            filteredEvaluations = allEvaluations;
            updateStats();
            renderEvaluations();
        }

        // Atualizar estat√≠sticas com barras de progresso
        function updateStats() {
            const total = allEvaluations.length;
            document.getElementById('totalEvaluations').textContent = total;

            const pending = allEvaluations.filter(e => e.status === 'Pendente').length;
            document.getElementById('pendingEvaluations').textContent = pending;
            const pendingPercent = total > 0 ? (pending / total) * 100 : 0;
            document.getElementById('pendingProgress').style.width = pendingPercent + '%';

            const completed = allEvaluations.filter(e => e.status === 'Conclu√≠da').length;
            document.getElementById('completedEvaluations').textContent = completed;
            const completedPercent = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('completedProgress').style.width = completedPercent + '%';

            const withAI = allEvaluations.filter(e => e.aiAssisted).length;
            document.getElementById('aiEvaluations').textContent = withAI;
            const aiPercent = total > 0 ? (withAI / total) * 100 : 0;
            document.getElementById('aiProgress').style.width = aiPercent + '%';
        }

        // Renderizar avalia√ß√µes
        function renderEvaluations() {
            const grid = document.getElementById('evaluationsGrid');
            grid.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageEvaluations = filteredEvaluations.slice(start, end);

            if (pageEvaluations.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-secondary);">Nenhuma avalia√ß√£o encontrada</div>';
                return;
            }

            pageEvaluations.forEach(evaluation => {
                const patient = PatientsManager.getById(evaluation.patientId);
                const patientName = patient ? patient.nome : 'Paciente Desconhecido';

                const statusColors = {
                    'Conclu√≠da': '#27ae60',
                    'Pendente': '#f39c12',
                    'Em Andamento': '#3498db'
                };

                const typeIcons = {
                    'cognitive': 'fa-brain',
                    'neurological': 'fa-wave-square',
                    'imaging': 'fa-x-ray',
                    'lab': 'fa-flask'
                };

                const card = document.createElement('div');
                card.className = 'evaluation-card';
                card.innerHTML = `
                    <div class="evaluation-header">
                        <div class="evaluation-type">
                            <i class="fas ${typeIcons[evaluation.type] || 'fa-clipboard'}"></i>
                            ${evaluation.type === 'cognitive' ? 'Cognitiva' :
                              evaluation.type === 'neurological' ? 'Neurol√≥gica' :
                              evaluation.type === 'imaging' ? 'Imagem' : 'Laborat√≥rio'}
                        </div>
                        <span class="evaluation-status" style="background: ${statusColors[evaluation.status] || '#95a5a6'}">
                            ${evaluation.status}
                        </span>
                    </div>
                    <div class="evaluation-patient">
                        <strong>${patientName}</strong>
                        <small>${evaluation.patientId}</small>
                    </div>
                    <div class="evaluation-info">
                        <div class="info-item">
                            <i class="fas fa-calendar"></i>
                            <span>${evaluation.date}</span>
                        </div>
                        ${evaluation.aiAssisted ? '<div class="info-item"><i class="fas fa-robot" style="color: #667eea;"></i><span>IA Assistida</span></div>' : ''}
                    </div>
                    ${evaluation.aiProbabilities ? `
                        <div class="evaluation-ai-summary">
                            <small>Probabilidades:</small>
                            <div class="mini-probability-bar">
                                <div style="width: ${evaluation.aiProbabilities.alzheimer}%; background: #e74c3c;"></div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="evaluation-actions">
                        <button class="btn btn-sm btn-outline" onclick="viewEvaluation('${evaluation.patientId}')">
                            <i class="fas fa-eye"></i> Ver Detalhes
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });

            updatePagination();
        }

        // Atualizar pagina√ß√£o
        function updatePagination() {
            const totalPages = Math.ceil(filteredEvaluations.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `P√°gina ${currentPage} de ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            // Desabilitar pr√≥xima p√°gina se h√° 10 ou menos registros totais ou j√° est√° na √∫ltima p√°gina
            document.getElementById('nextPage').disabled = currentPage === totalPages || filteredEvaluations.length <= 10;
        }

        // Filtros
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                currentFilter = this.dataset.type;

                if (currentFilter === 'all') {
                    filteredEvaluations = allEvaluations;
                } else {
                    filteredEvaluations = allEvaluations.filter(e => e.type === currentFilter);
                }

                currentPage = 1;
                renderEvaluations();
            });
        });

        // Busca
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();

            filteredEvaluations = allEvaluations.filter(evaluation => {
                const patient = PatientsManager.getById(evaluation.patientId);
                const patientName = patient ? patient.nome.toLowerCase() : '';
                const type = evaluation.type.toLowerCase();

                return patientName.includes(searchTerm) ||
                       type.includes(searchTerm) ||
                       evaluation.patientId.toLowerCase().includes(searchTerm);
            });

            currentPage = 1;
            renderEvaluations();
        });

        // Pagina√ß√£o
        document.getElementById('prevPage').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderEvaluations();
            }
        });

        document.getElementById('nextPage').addEventListener('click', function() {
            const totalPages = Math.ceil(filteredEvaluations.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderEvaluations();
            }
        });

        // Ver avalia√ß√£o com modal detalhado
        function viewEvaluation(evaluationId) {
            const evaluation = allEvaluations.find(e => e.patientId === evaluationId);

            if (!evaluation) {
                alert('Avalia√ß√£o n√£o encontrada');
                return;
            }

            const patient = PatientsManager.getById(evaluation.patientId);
            const patientName = patient ? patient.nome : 'Paciente Desconhecido';

            const modalContent = document.getElementById('evaluationModalContent');
            modalContent.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Informa√ß√µes do Paciente</h4>
                        <p><strong>Nome:</strong> ${patientName}</p>
                        <p><strong>ID:</strong> ${evaluation.patientId}</p>
                    </div>
                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Detalhes da Avalia√ß√£o</h4>
                        <p><strong>Tipo:</strong> ${evaluation.type === 'cognitive' ? 'Cognitiva' :
                                                     evaluation.type === 'neurological' ? 'Neurol√≥gica' :
                                                     evaluation.type === 'imaging' ? 'Imagem' : 'Laborat√≥rio'}</p>
                        <p><strong>Data:</strong> ${evaluation.date}</p>
                        <p><strong>Status:</strong> <span class="badge ${evaluation.status === 'Conclu√≠da' ? 'badge-success' :
                                                                         evaluation.status === 'Pendente' ? 'badge-warning' :
                                                                         'badge-info'}">${evaluation.status}</span></p>
                        <p><strong>Assistido por IA:</strong> ${evaluation.aiAssisted ? 'Sim' : 'N√£o'}</p>
                    </div>
                    ${evaluation.aiProbabilities ? `
                        <div>
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Probabilidades da IA</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>Alzheimer</span>
                                        <strong>${evaluation.aiProbabilities.alzheimer}%</strong>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${evaluation.aiProbabilities.alzheimer}%; background: #e74c3c;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>DLB</span>
                                        <strong>${evaluation.aiProbabilities.dlb || 0}%</strong>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${evaluation.aiProbabilities.dlb || 0}%; background: #9b59b6;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>FTD</span>
                                        <strong>${evaluation.aiProbabilities.ftd || 0}%</strong>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${evaluation.aiProbabilities.ftd || 0}%; background: #3498db;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('evaluationModal').style.display = 'flex';
        }

        // Modal
        function closeEvaluationModal() {
            document.getElementById('evaluationModal').style.display = 'none';
        }

        function editEvaluation() {
            alert('Funcionalidade de edi√ß√£o ser√° implementada em breve');
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('evaluationModal');
            if (event.target === modal) {
                closeEvaluationModal();
            }
        }

        // Inicializar
        loadUserInfo();
        loadEvaluations();
    </script>

    <style>
        .evaluations-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .dashboard-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .dashboard-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .dashboard-info h3 {
            font-size: 2rem;
            margin: 0 0 5px 0;
            color: var(--text-primary);
        }

        .dashboard-info p {
            margin: 0 0 10px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .dashboard-progress {
            margin-top: auto;
        }

        .progress-bar {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            border-bottom: 1px solid #f0f0f0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 25px;
            border-top: 1px solid #f0f0f0;
        }

        .evaluations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .evaluation-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .evaluation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .evaluation-type {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            font-weight: 600;
        }

        .evaluation-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: white;
            font-weight: 500;
        }

        .evaluation-patient {
            margin-bottom: 15px;
        }

        .evaluation-patient strong {
            display: block;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .evaluation-patient small {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .evaluation-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .evaluation-info .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .evaluation-ai-summary {
            margin-bottom: 15px;
        }

        .evaluation-ai-summary small {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .mini-probability-bar {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .mini-probability-bar div {
            height: 100%;
            transition: width 0.3s;
        }

        .evaluation-actions {
            display: flex;
            gap: 10px;
        }

        .evaluation-actions .btn {
            flex: 1;
        }

        @media (max-width: 768px) {
            .evaluations-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
